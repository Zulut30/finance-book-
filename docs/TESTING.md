# Тестирование и проверки производительности

## Запуск тестов

```bash
npm test              # один прогон
npm run test:watch    # режим наблюдения
npm run test:coverage # отчёт о покрытии
```

## Покрытие

- **services/currencyService.ts** — конвертация валют, кэш, демо-курсы, граничные случаи.
- **api/lib/telegram.ts** — валидация Telegram Mini App `initData` (хэш, auth_date, user).
- **api/lib/storage.ts** — ключи пользователей, чтение/запись, нормализация данных.

`geminiService` и `userDataSync` не покрыты unit-тестами (внешние API и браузерный контекст).

## Тесты на производительность (в составе Vitest)

1. **currencyService**
   - 10 000 вызовов `convertCurrency(100, USD, EUR)` и `convertCurrency(50, PLN, RUB)` — ожидание &lt;500 ms.
   - 10 000 вызовов `convertToPLN(100, EUR)` — ожидание &lt;200  ms.

2. **storage**
   - 100 пар операций `setUserData` + `getUserData` — ожидание &lt;200  ms (in-memory без Redis).

При падении этих тестов стоит проверить окружение и загрузку CPU.

## Память и ограничения

| Компонент | Ограничение |
|-----------|-------------|
| Кэш курсов валют | Один объект в памяти, TTL 1 час, без роста по количеству записей. |
| In-memory хранилище (без KV) | Не более 5000 ключей; при превышении удаляются старые. |
| Синхронизация с сервером | Debounce 2 с; один запрос с полным набором данных при изменениях. |

## Рекомендации

- Перед релизом запускать `npm test` и при необходимости `npm run test:coverage`.
- При изменении логики конвертации валют или хранилища — добавить/обновить тесты в `*.test.ts`.
